name: HTML Validation Pipeline

on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:

  html-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Executar valida√ß√£o HTML
        run: |
          echo "üöÄ Iniciando pipeline de valida√ß√£o HTML"
          chmod +x validate-html.sh
          ./validate-html.sh

      - name: Verificar arquivos est√°ticos
        run: |
          echo "üîç Verificando arquivos est√°ticos..."
          
          # Verificar se CSS existe
          if [ -f "static/css/main.css" ]; then
            echo "‚úÖ Arquivo CSS principal encontrado"
          else
            echo "‚ùå Arquivo CSS principal n√£o encontrado"
            exit 1
          fi
          
          # Verificar se diret√≥rio de imagens existe
          if [ -d "static/imgs" ]; then
            echo "‚úÖ Diret√≥rio de imagens encontrado"
          else
            echo "‚ùå Diret√≥rio de imagens n√£o encontrado"
            exit 1
          fi

      - name: Valida√ß√£o sint√°tica HTML
        run: |
          echo "üîç Verificando sintaxe HTML..."
          # Verificar se n√£o h√° tags n√£o fechadas b√°sicas
          python3 -c "
          import re
          
          with open('templates/index.html', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Verifica√ß√µes b√°sicas de sintaxe
          errors = []
          
          # Verificar se todas as tags html, head, body est√£o fechadas
          if content.count('<html') != content.count('</html>'):
              errors.append('Tag html n√£o fechada corretamente')
              
          if content.count('<head>') != content.count('</head>'):
              errors.append('Tag head n√£o fechada corretamente')
              
          if content.count('<body>') != content.count('</body>'):
              errors.append('Tag body n√£o fechada corretamente')
          
          # Verificar estrutura b√°sica
          if not re.search(r'<!DOCTYPE html>', content, re.IGNORECASE):
              errors.append('DOCTYPE n√£o encontrado')
              
          if errors:
              for error in errors:
                  print(f'‚ùå {error}')
              exit(1)
          else:
              print('‚úÖ Sintaxe HTML b√°sica v√°lida')
          "

  commit-changes:
    needs: html-validation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Verificar mudan√ßas e fazer commit
        run: |
          echo "üìù Verificando se h√° mudan√ßas para commit..."
          
          # Verificar se h√° mudan√ßas
          if git diff --quiet && git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  Nenhuma mudan√ßa detectada para commit"
          else
            echo "üìù Mudan√ßas detectadas, fazendo commit..."
            git add .
            git commit -m "üîÑ Valida√ß√£o HTML executada com sucesso - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "‚úÖ Commit realizado com sucesso!"
          fi
